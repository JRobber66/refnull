<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RefNull</title>
<style>
  :root { --bg:#0f1115; --text:#e9edf3; --muted:#9aa3b2; --card:#161a21; --border:#262c38; --accent:#4f8cff; --ok:#19c37d; }
  @media (prefers-color-scheme: light) {
    :root { --bg:#f6f7fb; --text:#0b0c0f; --muted:#5d6b82; --card:#ffffff; --border:#e6eaf2; --accent:#3759ff; --ok:#12a66a; }
  }
  * { box-sizing: border-box; }
  body { margin: 0; padding: 12px; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  .wrap { max-width: 720px; margin: 0 auto; }
  .card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 12px; margin: 12px 0; }
  .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  button {
    appearance: none; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border);
    background: var(--accent); color: #fff; font-weight: 600; cursor: pointer; flex: 1;
  }
  button.secondary { background: transparent; color: var(--text); }
  button[disabled]{ opacity:.6; cursor:not-allowed; }
  .label { color: var(--muted); font-size: 14px; margin-top: 4px; }
  .kv { display:flex; justify-content:space-between; align-items:center; padding:8px 0; gap:8px; }
  .value { text-align:right; }
  .emails { display: grid; gap: 8px; }
  .email { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 10px; }
  .status { font-size: 13px; color: var(--muted); }
  @media (max-width: 480px) {
    .kv { flex-direction: column; align-items: flex-start; }
    .value { text-align:left; width:100%; }
    button { flex: unset; width: 100%; }
  }
</style>
</head>
<body>
<div class="wrap">

  <!-- STEP 1: Name & DOB -->
  <div class="card">
    <div class="row">
      <button id="btnName">Generate Name & DOB</button>
      <button id="btnReroll" class="secondary" disabled>Reroll Name</button>
    </div>
    <div class="label">Name & DOB</div>
    <div class="kv"><div>Alias</div><div class="value mono" id="aliasOut">—</div></div>
    <div class="kv"><div>DOB</div><div class="value mono" id="dobOut">—</div></div>
    <div class="status" id="statusName">idle</div>
  </div>

  <!-- STEP 2: Email (hidden until name exists) -->
  <div class="card" id="emailCard" style="display:none;">
    <div class="row">
      <button id="btnEmail">Create Email & Start Inbox</button>
      <button id="btnCopy" class="secondary" disabled>Copy</button>
    </div>
    <div class="label">Email</div>
    <div class="kv"><div>Address</div><div class="value mono" id="emailOut">—</div></div>
    <div class="kv"><div>Status</div><div class="value mono" id="liveStatus">idle</div></div>
  </div>

  <!-- Inbox -->
  <div class="card">
    <div class="kv"><div>Inbox</div><div class="value status" id="msgCount">0</div></div>
    <div id="emails" class="emails"></div>
  </div>

</div>

<script>
  // ======== CONFIG ========
  const API_BASE = "https://nullrefback-production.up.railway.app"; // your backend
  // ========================

  const $ = (id) => document.getElementById(id);

  // Elements
  const btnName   = $("btnName");
  const btnReroll = $("btnReroll");
  const btnEmail  = $("btnEmail");
  const btnCopy   = $("btnCopy");

  const aliasOut  = $("aliasOut");
  const dobOut    = $("dobOut");
  const statusName= $("statusName");

  const emailCard = $("emailCard");
  const emailOut  = $("emailOut");
  const liveStatus= $("liveStatus");

  const emailsEl  = $("emails");
  const msgCountEl= $("msgCount");

  // State
  let sessionData = null;          // { alias, dobISO, dobPretty, email }
  let current = { alias:null, dobISO:null, dobPretty:null, email:null };
  let es = null, pollTimer = null, renderedCount = 0;

  // Helpers
  const setLive = (t) => liveStatus.textContent = t;
  const setCount = (n) => msgCountEl.textContent = n;
  const sanitize = (s) => (s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

  function renderEmailCard(payload) {
    const d = JSON.parse(payload.data);
    const s = d.simplified || {};
    const el = document.createElement("div");
    el.className = "email";
    el.innerHTML = `
      <div><b>From:</b> <span class="mono">${sanitize(s.from||"")}</span></div>
      <div><b>To:</b>   <span class="mono">${sanitize(s.to||"")}</span></div>
      <div style="margin-top:4px"><b>Subject:</b> <span class="mono">${sanitize(s.subject||"")}</span></div>
      ${s.text ? `<pre class="mono" style="margin-top:6px;white-space:pre-wrap;">${sanitize(s.text)}</pre>` : ""}
      ${s.html ? `<details style="margin-top:6px;"><summary>HTML (sanitized)</summary><div class="mono" style="white-space:pre-wrap;">${sanitize(s.html)}</div></details>` : ""}
      <details style="margin-top:6px;"><summary>Raw JSON</summary><pre class="mono" style="white-space:pre-wrap;">${sanitize(JSON.stringify(d.raw||{}, null, 2))}</pre></details>
    `;
    emailsEl.prepend(el);
    renderedCount += 1; setCount(renderedCount);
  }

  function renderBacklog(payload) {
    const arr = JSON.parse(payload.data) || [];
    for (const raw of arr) {
      const simplified = {
        from: raw.From, to: raw.To, subject: raw.Subject,
        text: raw.TextBody, html: raw.HtmlBody,
        attachments: (raw.Attachments||[]).map(a => ({Name:a.Name, ContentType:a.ContentType, ContentLength:a.ContentLength}))
      };
      renderEmailCard({ data: JSON.stringify({ simplified, raw }) });
    }
  }

  async function pollMessages() {
    if (!current.alias) return;
    try {
      const resp = await fetch(`${API_BASE}/api/messages/${encodeURIComponent(current.alias)}`);
      if (!resp.ok) return;
      const data = await resp.json();
      const arr = Array.isArray(data.messages) ? data.messages : [];
      if (arr.length > renderedCount) {
        const newOnes = arr.slice(renderedCount);
        for (const raw of newOnes) {
          const simplified = {
            from: raw.From, to: raw.To, subject: raw.Subject,
            text: raw.TextBody, html: raw.HtmlBody,
            attachments: (raw.Attachments||[]).map(a => ({Name:a.Name, ContentType:a.ContentType, ContentLength:a.ContentLength}))
          };
          renderEmailCard({ data: JSON.stringify({ simplified, raw }) });
        }
      }
    } catch {}
  }

  async function createSession() {
    const resp = await fetch(`${API_BASE}/api/session`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({})
    });
    if (!resp.ok) throw new Error("create session failed");
    return resp.json();
  }

  // STEP 1: Generate / Reroll Name & DOB
  btnName.onclick = async () => {
    statusName.textContent = "generating…";
    btnName.disabled = true;
    try {
      sessionData = await createSession();
      current.alias = sessionData.alias;
      current.dobISO = sessionData.dobISO;
      current.dobPretty = sessionData.dobPretty;

      aliasOut.textContent = current.alias;
      dobOut.textContent = `${current.dobPretty} (${current.dobISO})`;

      statusName.textContent = "ready";
      btnReroll.disabled = false;

      // reveal step 2 now
      emailCard.style.display = "";
      // reset step-2 UI
      emailOut.textContent = "—";
      btnCopy.disabled = true;
      liveStatus.textContent = "idle";
    } catch {
      statusName.textContent = "error";
    } finally {
      btnName.disabled = false;
    }
  };

  btnReroll.onclick = async () => {
    // Reroll just repeats step 1 (new session)
    // Stop any running inbox
    if (es) { es.close(); es = null; }
    if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
    emailsEl.innerHTML = ""; renderedCount = 0; setCount(0);

    statusName.textContent = "generating…";
    btnReroll.disabled = true;
    btnEmail.disabled = false; // allow starting inbox after reroll
    try {
      sessionData = await createSession();
      current.alias = sessionData.alias;
      current.dobISO = sessionData.dobISO;
      current.dobPretty = sessionData.dobPretty;

      aliasOut.textContent = current.alias;
      dobOut.textContent = `${current.dobPretty} (${current.dobISO})`;

      statusName.textContent = "ready";
      // reset step 2 view
      emailOut.textContent = "—";
      current.email = null;
      btnCopy.disabled = true;
      setLive("idle");
    } catch {
      statusName.textContent = "error";
    } finally {
      btnReroll.disabled = false;
    }
  };

  // STEP 2: Create Email & Start Inbox
  btnEmail.onclick = () => {
    if (!sessionData) return;
    btnEmail.disabled = true;

    // reveal email
    current.email = sessionData.email;
    emailOut.textContent = current.email;
    btnCopy.disabled = false;

    // reset inbox view
    emailsEl.innerHTML = ""; renderedCount = 0; setCount(0);

    // SSE
    setLive("connecting…");
    es = new EventSource(`${API_BASE}/api/stream/${encodeURIComponent(current.alias)}`);
    es.addEventListener("backlog", renderBacklog);
    es.addEventListener("email", renderEmailCard);
    es.onopen  = () => setLive("live");
    es.onerror = () => setLive("disconnected");

    // Poll fallback
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(pollMessages, 1000);
  };

  // Copy button with quick feedback
  btnCopy.onclick = async () => {
    if (!current.email) return;
    const prev = btnCopy.textContent;
    btnCopy.disabled = true;
    try {
      await navigator.clipboard.writeText(current.email);
      btnCopy.textContent = "Copied!";
      btnCopy.style.background = "var(--ok)";
      setTimeout(() => {
        btnCopy.textContent = "Copy";
        btnCopy.style.background = "transparent";
        btnCopy.disabled = false;
        btnCopy.classList.add("secondary"); // keep secondary look
      }, 800);
    } catch {
      btnCopy.textContent = "Copy failed";
      setTimeout(() => {
        btnCopy.textContent = "Copy";
        btnCopy.disabled = false;
      }, 1100);
    }
  };
</script>
</body>
</html>
