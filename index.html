<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RefNull — Alias & Inbox</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root { --bg:#0c0f14; --card:#121722; --text:#e8ecf4; --muted:#9aa3b2; --accent:#7aa2ff; --border:#222838; }
  @media (prefers-color-scheme: light) {
    :root { --bg:#f6f7fb; --card:#ffffff; --text:#0b0c0f; --muted:#566074; --accent:#3759ff; --border:#e7eaf2; }
  }
  html,body{height:100%}
  body{margin:0;padding:24px;background:radial-gradient(1200px 800px at 10% 10%,#1a2134 0%,var(--bg) 45%);color:var(--text);
       font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:980px;margin:0 auto}
  h1{margin:0 0 8px} .sub{margin:0 0 18px;color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin:16px 0;box-shadow:0 6px 20px rgba(0,0,0,.15)}
  .row{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:end}
  label{display:inline-block;margin-bottom:6px;color:var(--muted);font-size:14px}
  input,button{padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text);font-size:15px}
  button{background:var(--accent);color:#fff;border:0;cursor:pointer;font-weight:600}
  button.secondary{background:transparent;color:var(--text);border:1px solid var(--border)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .kv{display:grid;grid-template-columns:130px 1fr;gap:12px;align-items:center}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:0.95rem}
  code,pre{background:rgba(127,127,127,.08);padding:2px 6px;border-radius:8px}
  .emails{display:grid;gap:12px}
  .email{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
  .right{text-align:right} .hint{color:var(--muted);font-size:13px}
  details{border-top: 1px dashed var(--border);margin-top:8px;padding-top:8px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(122,162,255,.12);
        border:1px solid rgba(122,162,255,.25)}
</style>
</head>
<body>
<div class="wrap">
  <h1>RefNull — Alias & Inbox</h1>
  <p class="sub">Generate a realistic alias with an over-21 DOB and a catch-all email. Emails to that address stream in live.</p>

  <div class="card">
    <div class="row">
      <div>
        <label for="alias">Custom alias (optional)</label>
        <input id="alias" placeholder="e.g., Jordan-Wright482" autocomplete="off" />
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="make">Generate alias + DOB</button>
        <button id="stop" class="secondary" type="button">Stop stream</button>
        <button id="clear" class="secondary" type="button">Clear</button>
      </div>
    </div>

    <div style="margin-top:12px" class="grid2">
      <div class="kv"><div>Alias</div> <div class="mono" id="out-alias">—</div></div>
      <div class="kv"><div>DOB</div>   <div class="mono" id="out-dob">—</div></div>
      <div class="kv">
        <div>Email</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <span class="mono" id="out-email">—</span>
          <button id="copyEmail" class="secondary" type="button">Copy</button>
          <a id="mailto" class="pill mono" href="#" target="_blank" rel="noopener">mailto</a>
        </div>
      </div>
      <div class="kv"><div>Status</div> <div class="mono" id="status">idle</div></div>
    </div>
    <p class="hint" style="margin-top:6px">Keep this tab open to maintain the live stream. Polling runs every 1s as a fallback.</p>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Incoming Emails</h3>
      <div class="hint" id="count">0 messages</div>
    </div>
    <div id="emails" class="emails"></div>
  </div>
</div>

<script>
  // ================= CONFIG =================
  const API_BASE = "https://nullrefback-production.up.railway.app"; // <- your backend
  // ==========================================

  const $ = (id) => document.getElementById(id);
  const aliasInput = $("alias"), makeBtn = $("make"), stopBtn = $("stop"), clearBtn = $("clear");
  const outAlias = $("out-alias"), outDob = $("out-dob"), outEmail = $("out-email");
  const copyEmailBtn = $("copyEmail"), mailtoLink = $("mailto");
  const statusEl = $("status"), emailsEl = $("emails"), countEl = $("count");

  let es = null, currentAlias = null, msgCount = 0, pollTimer = null;

  const setStatus = (t) => statusEl.textContent = t;
  const fmtCount = (n) => countEl.textContent = `${n} message${n===1?"":"s"}`;
  const sanitize = (s) => (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  function renderEmailCard(payload) {
    const d = JSON.parse(payload.data);
    const s = d.simplified || {};
    const el = document.createElement("div");
    el.className = "email";
    el.innerHTML = `
      <div class="grid2">
        <div><b>From:</b> <span class="mono">${sanitize(s.from||"")}</span></div>
        <div class="right"><b>To:</b> <span class="mono">${sanitize(s.to||"")}</span></div>
      </div>
      <div style="margin-top:4px"><b>Subject:</b> <span class="mono">${sanitize(s.subject||"")}</span></div>
      ${s.text ? `<pre class="mono" style="margin-top:8px;white-space:pre-wrap;">${sanitize(s.text)}</pre>` : ""}
      ${s.html ? `<details style="margin-top:6px;"><summary>HTML (sanitized)</summary><div class="mono" style="white-space:pre-wrap;">${sanitize(s.html)}</div></details>` : ""}
      <details style="margin-top:8px;"><summary>Raw JSON</summary><pre class="mono" style="white-space:pre-wrap;">${sanitize(JSON.stringify(d.raw||{}, null, 2))}</pre></details>
    `;
    emailsEl.prepend(el);
    msgCount += 1; fmtCount(msgCount);
  }

  function renderBacklog(payload) {
    const arr = JSON.parse(payload.data) || [];
    for (const raw of arr) {
      const simplified = {
        from: raw.From, to: raw.To, subject: raw.Subject,
        text: raw.TextBody, html: raw.HtmlBody,
        attachments: (raw.Attachments||[]).map(a => ({Name:a.Name, ContentType:a.ContentType, ContentLength:a.ContentLength}))
      };
      renderEmailCard({ data: JSON.stringify({ simplified, raw }) });
    }
  }

  async function pollMessages() {
    if (!currentAlias) return;
    try {
      const resp = await fetch(`${API_BASE}/api/messages/${encodeURIComponent(currentAlias)}`);
      if (!resp.ok) return;
      const data = await resp.json();
      const arr = Array.isArray(data.messages) ? data.messages : [];
      if (arr.length > msgCount) {
        const newOnes = arr.slice(msgCount); // append-only growth
        for (const raw of newOnes) {
          const simplified = {
            from: raw.From, to: raw.To, subject: raw.Subject,
            text: raw.TextBody, html: raw.HtmlBody,
            attachments: (raw.Attachments||[]).map(a => ({Name:a.Name, ContentType:a.ContentType, ContentLength:a.ContentLength}))
          };
          renderEmailCard({ data: JSON.stringify({ simplified, raw }) });
        }
      }
    } catch (_) {}
  }

  async function createSession() {
    if (es) { es.close(); es = null; }
    if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
    emailsEl.innerHTML = ""; msgCount = 0; fmtCount(0); setStatus("creating…");

    const alias = aliasInput.value.trim();
    const resp = await fetch(`${API_BASE}/api/session`, {
      method: "POST", headers: {"Content-Type":"application/json"},
      body: JSON.stringify(alias ? { alias } : {})
    });
    if (!resp.ok) { setStatus("error creating session"); return; }

    const data = await resp.json();
    currentAlias = data.alias;

    outAlias.textContent = data.alias;
    outDob.textContent   = `${data.dobPretty} (${data.dobISO})`;
    outEmail.textContent = data.email;
    copyEmailBtn.onclick = () => navigator.clipboard.writeText(data.email);
    mailtoLink.href = `mailto:${encodeURIComponent(data.email)}`;
    setStatus("connecting…");

    // SSE live stream
    es = new EventSource(`${API_BASE}/api/stream/${encodeURIComponent(currentAlias)}`);
    es.addEventListener("backlog", renderBacklog);
    es.addEventListener("email", renderEmailCard);
    es.onopen  = () => setStatus("live");
    es.onerror = () => setStatus("disconnected");

    // 1-second polling fallback
    pollTimer = setInterval(pollMessages, 1000);
  }

  $("make").addEventListener("click", createSession);
  $("stop").addEventListener("click", () => {
    if (es) es.close(); es = null;
    if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
    setStatus("stopped");
  });
  $("clear").addEventListener("click", () => { emailsEl.innerHTML = ""; msgCount = 0; fmtCount(0); });

  // Optional: auto-generate on load
  // createSession();
</script>
</body>
</html>
