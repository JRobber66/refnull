<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mail — Login</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:16px;max-width:720px}
  label{display:block;margin:10px 0 6px}
  input,button{font:inherit}
  input[type=text],input[type=password],input[type=url],input[type=number]{width:100%;padding:.6rem;border:1px solid #ccc;border-radius:.5rem}
  button{padding:.6rem 1rem;border:1px solid #ccc;border-radius:.6rem;background:#111;color:#fff}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .muted{color:#666;font-size:.9rem}
  pre{background:#0f172a;color:#e2e8f0;padding:10px;border-radius:8px;overflow:auto}
</style>
<h1>Login</h1>

<label>Agent URL (https)</label>
<input id="agent" type="url" placeholder="https://agent.refnull.net" />

<div class="row">
  <div>
    <label>Email</label>
    <input id="email" type="text" placeholder="you@evilgato.org" />
  </div>
  <div>
    <label>Password</label>
    <input id="password" type="password" />
  </div>
</div>

<div class="row">
  <div>
    <label>IMAP Host</label>
    <input id="host" type="text" value="mail.evilgato.org" />
  </div>
  <div class="row" style="grid-template-columns:1fr 1fr;gap:10px">
    <div>
      <label>Port</label>
      <input id="port" type="number" value="993" />
    </div>
    <div>
      <label>&nbsp;</label>
      <div><label class="muted"><input id="secure" type="checkbox" checked /> TLS (IMAPS)</label></div>
    </div>
  </div>
</div>

<label class="muted"><input id="insecureTls" type="checkbox" /> Allow insecure TLS (testing only)</label>

<p>
  <button id="save">Save Agent</button>
  <button id="login">Login</button>
</p>

<pre id="log"></pre>

<script>
const $ = (id)=>document.getElementById(id);
const log=(o)=>{$('log').textContent += JSON.stringify(o,null,2)+"\n\n";};

// Resolve agent URL: ?agent=... overrides, else localStorage, else default
function resolveAgent() {
  const qp = new URLSearchParams(location.search);
  const p = qp.get('agent');
  if (p) { localStorage.setItem('agent', p); return p; }
  return localStorage.getItem('agent') || 'https://agent.refnull.net';
}

function agent() { return $('agent').value.trim() || resolveAgent(); }

window.addEventListener('DOMContentLoaded', () => {
  $('agent').value = resolveAgent();
  $('secure').checked = true;
});

$('save').onclick = () => {
  const a = agent();
  localStorage.setItem('agent', a);
  log({savedAgent:a});
  alert('Saved agent: ' + a);
};

$('login').onclick = async () => {
  const a = agent();
  const body = {
    email: $('email').value.trim(),
    password: $('password').value,
    host: $('host').value.trim(),
    port: Number($('port').value || 993),
    secure: $('secure').checked,
    insecureTls: $('insecureTls').checked
  };
  try {
    log({fetch:{url:a+'/api/auth/login-plain',method:'POST'}, body});
    const r = await fetch(a + '/api/auth/login-plain', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body),
      mode:'cors'
    });
    const j = await r.json();
    log({status:r.status,json:j});
    if (j.ok) {
      localStorage.setItem('email', body.email);
      localStorage.setItem('password', body.password);
      alert('Login OK. Opening inbox…');
      location.href = 'inbox.html';
    } else {
      alert('Login failed: ' + (j.error || r.status));
    }
  } catch (e) {
    log({error:e.name, message:e.message});
    alert('Fetch error: ' + e.message);
  }
};
</script>
