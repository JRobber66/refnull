<!doctype html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Ratify</title><style>:root{--pad:14px;--gap:12px}*{box-sizing:border-box}body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#fafafa;color:#111}header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:12px 14px}h1{margin:0;font-size:18px}main{max-width:980px;margin:16px auto;padding:0 14px}card,section{display:block}label{display:block;margin-top:8px;color:#444;font-size:13px}input,select,button{font-size:16px;padding:12px;border-radius:10px;border:1px solid #cbd5e1}button.primary{background:#0b63d7;color:#fff;border:0}button.ghost{background:#f3f4f6;border:0}fieldset{border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:12px}.row{display:flex;gap:8px;flex-wrap:wrap}.candidate{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:12px 0;border-bottom:1px dashed #eee}.meta{font-size:13px;color:#666;margin-top:6px}.status{font-size:12px;padding:4px 8px;border-radius:999px;background:#f1f5f9;margin-left:8px;text-transform:capitalize}.status.banned{background:#e6ffed;color:#0a7a28}.status.allowed{background:#eef2ff;color:#3340a0}.votes{font-size:12px;color:#333;margin-left:6px;white-space:nowrap}.pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#f8fafc;border:1px solid #e5e7eb;margin:4px 6px 0 0;font-size:14px}@media(max-width:800px){input,button{width:100%}.row{flex-direction:column}}</style></head><body><header><h1>Ratify ‚Äî Ban List</h1><div id="authState" style="font-size:13px;color:#555">Not logged in</div></header><main><fieldset id="authCard"><label>Member</label><select id="member-select"></select><label>4-digit PIN (MMDD)</label><input id="pin" type="password" maxlength="4" inputmode="numeric" pattern="[0-9]*" placeholder="MMDD"/><div class="row"><button id="loginBtn" class="primary">Login</button><button id="logoutBtn" class="ghost" style="display:none">Logout</button></div><div id="need2fa" style="display:none;margin-top:10px"><label>Secondary code</label><input id="secondary" placeholder="Enter secondary code"/><div class="row"><button id="verify2" class="primary">Verify</button></div></div><div id="authMessage" style="margin-top:8px;font-size:13px;color:#666">Use your 4-digit PIN.</div></fieldset><fieldset id="addCard"><label>First name</label><input id="firstName" placeholder="First name"/><label>Last initial</label><input id="lastInitial" maxlength="1" placeholder="Initial"/><label>Notes (optional)</label><input id="notes" placeholder="Context (optional)"/><div class="row" style="margin-top:10px"><button id="addBtn" class="primary">Add</button><button id="refreshBtn" class="ghost">Refresh</button></div><div id="addMessage" style="margin-top:8px;font-size:13px;color:#666"></div></fieldset><fieldset id="listCard"><legend style="font-weight:600">Current list</legend><div id="listArea" style="margin-top:8px">Loading...</div><div style="font-size:13px;color:#666;margin-top:8px">Pending first. Unanimous YES ‚Üí Banned. Unanimous NO ‚Üí Allowed üïäÔ∏è</div></fieldset><fieldset style="margin-top:12px"><legend style="font-weight:600">Confirmed ban list</legend><div id="bannedList">‚Äî</div></fieldset><fieldset style="margin-top:12px"><legend style="font-weight:600">Allowed list üïäÔ∏è</legend><div id="allowedList">‚Äî</div></fieldset></main><script>const API='https://ratification-production.up.railway.app';async function api(p,o={}){const r=await fetch(API+p,{headers:{'Content-Type':'application/json'},...o});if(!r.ok){const txt=await r.text().catch(()=>r.statusText);throw new Error(txt)}const ct=r.headers.get('content-type')||'';return ct.includes('application/json')?r.json():r.text()}let logged=null;const memberSelect=document.getElementById('member-select'),pin=document.getElementById('pin'),loginBtn=document.getElementById('loginBtn'),logoutBtn=document.getElementById('logoutBtn'),authMsg=document.getElementById('authMessage'),authState=document.getElementById('authState'),need2fa=document.getElementById('need2fa'),secondaryInput=document.getElementById('secondary'),verify2=document.getElementById('verify2'),listArea=document.getElementById('listArea'),bannedList=document.getElementById('bannedList'),allowedList=document.getElementById('allowedList'),addBtn=document.getElementById('addBtn'),refreshBtn=document.getElementById('refreshBtn'),addMsg=document.getElementById('addMessage');function esc(s){return(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}async function loadMembers(){try{const{members}=await api('/members');memberSelect.innerHTML='';members.forEach(m=>{const o=document.createElement('option');o.value=m;o.textContent=m;memberSelect.appendChild(o)})}catch(e){memberSelect.innerHTML='<option>(error)</option>'}}loginBtn.addEventListener('click',async()=>{const memberName=memberSelect.value,mm=pin.value.trim();if(!memberName||mm.length!==4){authMsg.textContent='Select member and enter MMDD.';return}try{const r=await api('/auth',{method:'POST',body:JSON.stringify({memberName,pin:mm})});if(r.need2fa){need2fa.style.display='block';authMsg.textContent='Secondary code required for this account'}else if(r.ok){logged=memberName;authMsg.textContent=`Logged in as ${memberName}`;authState.textContent=`Logged in: ${memberName}${memberName==='Daniel'?' (admin)':''}`;loginBtn.style.display='none';logoutBtn.style.display='';pin.value='';await loadCandidates()}else authMsg.textContent='Login failed'}catch(e){authMsg.textContent='Login failed'}});verify2.addEventListener('click',async()=>{const memberName=memberSelect.value,sec=secondaryInput.value.trim();if(!memberName||!sec){authMsg.textContent='Enter secondary code';return}try{const r=await api('/auth/2',{method:'POST',body:JSON.stringify({memberName,secondary:sec})});if(r.ok){logged=memberName;authMsg.textContent=`Logged in as ${memberName}`;authState.textContent=`Logged in: ${memberName}${memberName==='Daniel'?' (admin)':''}`;need2fa.style.display='none';loginBtn.style.display='none';logoutBtn.style.display='';secondaryInput.value='';await loadCandidates()}else authMsg.textContent='Verification failed'}catch(e){authMsg.textContent='Verification failed'}});logoutBtn.addEventListener('click',async()=>{logged=null;authMsg.textContent='Logged out';authState.textContent='Not logged in';loginBtn.style.display='';logoutBtn.style.display='none';await loadCandidates()});function isAdmin(){return logged==='Daniel'}function renderSide(candidates){const banned=candidates.filter(c=>c.status==='banned'),allowed=candidates.filter(c=>c.status==='allowed');bannedList.innerHTML=banned.length?banned.map(c=>`<span class="pill">${esc(c.firstName)} ${esc(c.lastInitial)}.</span>`).join(' '):'‚Äî';allowedList.innerHTML=allowed.length?allowed.map(c=>`<span class="pill">${esc(c.firstName)} ${esc(c.lastInitial)}.</span>`).join(' '):'‚Äî'}function sortForMain(c){const r={pending:0,allowed:1,banned:2};return[...c].sort((a,b)=>{const x=(r[a.status]||99)-(r[b.status]||99);return x!==0?x:(a.createdAt||'').localeCompare(b.createdAt||'')})}async function loadCandidates(){try{const{candidates=[]}=await api('/candidates');renderSide(candidates);const sorted=sortForMain(candidates);if(!sorted.length){listArea.innerHTML='<div style="font-size:13px;color:#666">No names yet.</div>';return}listArea.innerHTML='';sorted.forEach(c=>{const wrap=document.createElement('div');wrap.className='candidate';const left=document.createElement('div');const title=document.createElement('div');title.innerHTML=`<strong>${esc(c.firstName)} ${esc(c.lastInitial)}.</strong> <span class="status ${c.status}">${c.status}</span>`;const meta=document.createElement('div');meta.className='meta';meta.textContent=c.notes?`Notes: ${c.notes}`:'No notes';left.appendChild(title);left.appendChild(meta);const right=document.createElement('div');right.style.display='flex';right.style.alignItems='center';right.style.gap='8px';if(c.status==='pending'){const yes=document.createElement('button');yes.textContent='Vote YES';yes.className='ghost';yes.onclick=()=>castVote(c.id,true);const no=document.createElement('button');no.textContent='Vote NO';no.className='ghost';no.onclick=()=>castVote(c.id,false);right.appendChild(yes);right.appendChild(no)}const yesCount=Object.values(c.votes||{}).filter(x=>x===true).length;const noCount=Object.values(c.votes||{}).filter(x=>x===false).length;const votes=document.createElement('div');votes.className='votes';votes.textContent=`Votes: ${Object.keys(c.votes||{}).length}/${c.totalMembers} (Yes:${yesCount} No:${noCount})`;right.appendChild(votes);if(isAdmin()){const adminRow=document.createElement('div');adminRow.style.display='flex';adminRow.style.flexWrap='wrap';adminRow.style.gap='8px';const makeBtn=(t,fn)=>{const b=document.createElement('button');b.className='ghost';b.textContent=t;b.onclick=fn;return b};adminRow.appendChild(makeBtn('Reopen',()=>adminAction(c.id,{action:'reopen'})));adminRow.appendChild(makeBtn('Delete',()=>{if(confirm('Delete this person?'))adminAction(c.id,{action:'delete'})}));adminRow.appendChild(makeBtn('Instant Ban',()=>adminAction(c.id,{action:'setStatus',status:'banned'})));adminRow.appendChild(makeBtn('Instant Allow',()=>adminAction(c.id,{action:'setStatus',status:'allowed'})));const rightWrap=document.createElement('div');rightWrap.style.display='flex';rightWrap.style.flexDirection='column';rightWrap.appendChild(right);rightWrap.appendChild(adminRow);wrap.appendChild(left);wrap.appendChild(rightWrap)}else{wrap.appendChild(left);wrap.appendChild(right)}listArea.appendChild(wrap)})}catch(e){listArea.innerHTML='<div style="color:#b00">Error loading list</div>'}}async function castVote(id,vote){if(!logged){alert('Login first.');return}try{await api('/vote',{method:'POST',body:JSON.stringify({candidateId:id,memberName:logged,vote})});await loadCandidates()}catch(e){console.error(e);alert('Vote failed')}}async function adminAction(id,body){await api(`/candidates/${encodeURIComponent(id)}`,{method:'PATCH',body:JSON.stringify(body)});await loadCandidates()}addBtn.addEventListener('click',async()=>{const first=document.getElementById('firstName').value.trim(),last=document.getElementById('lastInitial').value.trim(),notes=document.getElementById('notes').value.trim();addMsg.textContent='';if(!first||!last){addMsg.textContent='First name and last initial required.';return}try{await api('/candidates',{method:'POST',body:JSON.stringify({firstName:first,lastInitial:last[0].toUpperCase(),notes})});addMsg.textContent='Added.';document.getElementById('firstName').value='';document.getElementById('lastInitial').value='';document.getElementById('notes').value='';await loadCandidates()}catch(e){addMsg.textContent='Error: '+e.message}});refreshBtn.addEventListener('click',loadCandidates);(async function(){await loadMembers();await loadCandidates()})();</script></body></html>
