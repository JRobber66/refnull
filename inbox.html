<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mail â€” Inbox</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:16px;max-width:960px}
  header a{margin-right:10px}
  label{display:block;margin:10px 0 6px}
  input,button,select{font:inherit}
  input[type=text],input[type=number]{width:100%;padding:.6rem;border:1px solid #ccc;border-radius:.5rem}
  button{padding:.5rem .9rem;border:1px solid #ccc;border-radius:.6rem;background:#111;color:#fff}
  .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;font-size:.95rem}
  pre{background:#0f172a;color:#e2e8f0;padding:10px;border-radius:8px;overflow:auto}
</style>

<header>
  <a href="index.html">Login</a>
  <a href="inbox.html"><b>Inbox</b></a>
  <a href="compose.html">Compose</a>
</header>

<section>
  <div class="row">
    <div>
      <label>Agent</label>
      <input id="agent" type="text" placeholder="https://agent.refnull.net" />
    </div>
    <div>
      <label>Mailbox</label>
      <input id="mailbox" type="text" value="INBOX" />
    </div>
    <div>
      <label>Page</label>
      <input id="page" type="number" value="1" />
    </div>
  </div>
  <p>
    <button id="save">Save Agent</button>
    <button id="list">List</button>
  </p>

  <table id="listTable">
    <thead><tr><th>UID</th><th>Date</th><th>From</th><th>Subject</th><th>Size</th><th></th></tr></thead>
    <tbody></tbody>
  </table>

  <h3>Message</h3>
  <div class="row" style="grid-template-columns:1fr 1fr">
    <div>
      <label>UID</label>
      <input id="uid" type="number" />
    </div>
    <div style="align-self:end">
      <button id="get">Get</button>
    </div>
  </div>
  <pre id="msg"></pre>

  <h3>Raw (download)</h3>
  <div class="row" style="grid-template-columns:1fr 1fr">
    <div>
      <label>UID</label>
      <input id="rawUid" type="number" />
    </div>
    <div style="align-self:end">
      <button id="raw">Download .eml</button>
    </div>
  </div>
</section>

<pre id="log"></pre>

<script>
const $ = (id)=>document.getElementById(id);
const log=(o)=>{$('log').textContent += JSON.stringify(o,null,2)+"\n\n";};
function resolveAgent(){
  const qp=new URLSearchParams(location.search);
  const p=qp.get('agent'); if(p){localStorage.setItem('agent',p); return p;}
  return localStorage.getItem('agent') || 'https://agent.refnull.net';
}
function agent(){ return $('agent').value.trim() || resolveAgent(); }

function getCreds(){
  return {
    email: localStorage.getItem('email')||'',
    password: localStorage.getItem('password')||'',
  };
}

window.addEventListener('DOMContentLoaded',()=>{
  $('agent').value = resolveAgent();
});

$('save').onclick = ()=>{
  const a = agent();
  localStorage.setItem('agent', a);
  log({savedAgent:a});
  alert('Saved agent: ' + a);
};

$('list').onclick = async ()=>{
  const {email,password} = getCreds();
  if (!email || !password) { alert('Not logged in. Open index.html and login.'); return; }
  const a = agent();
  const mailbox = $('mailbox').value.trim() || 'INBOX';
  const page = Number($('page').value || 1);
  const url = new URL(a + '/api/imap/list');
  url.searchParams.set('email', email);
  url.searchParams.set('password', password);
  url.searchParams.set('mailbox', mailbox);
  url.searchParams.set('page', page);
  try{
    log({fetch:{url:String(url), method:'GET'}});
    const r = await fetch(url, {mode:'cors'});
    const j = await r.json();
    log({status:r.status,json:j});
    const tbody = $('listTable').querySelector('tbody');
    tbody.innerHTML = '';
    if (j.ok && Array.isArray(j.items)) {
      j.items.forEach(it=>{
        const tr = document.createElement('tr');
        const from = (it.from && it.from[0]) ? (it.from[0].name || it.from[0].address) : '';
        tr.innerHTML = `
          <td>${it.uid}</td>
          <td>${it.date || ''}</td>
          <td>${from || ''}</td>
          <td>${it.subject || ''}</td>
          <td>${it.size || ''}</td>
          <td><button data-uid="${it.uid}">Open</button></td>
        `;
        tr.querySelector('button').onclick = ()=>{
          $('uid').value = it.uid;
          $('rawUid').value = it.uid;
          $('get').click();
        };
        tbody.appendChild(tr);
      });
    } else {
      alert('List failed: ' + (j.error || r.status));
    }
  }catch(e){
    log({error:e.name,message:e.message});
    alert('Fetch error: ' + e.message);
  }
};

$('get').onclick = async ()=>{
  const {email,password} = getCreds();
  if (!email || !password) { alert('Not logged in.'); return; }
  const a = agent();
  const mailbox = $('mailbox').value.trim() || 'INBOX';
  const uid = Number($('uid').value);
  if (!uid) { alert('Enter UID'); return; }
  const url = new URL(a + '/api/imap/get');
  url.searchParams.set('email', email);
  url.searchParams.set('password', password);
  url.searchParams.set('mailbox', mailbox);
  url.searchParams.set('uid', uid);
  try{
    log({fetch:{url:String(url), method:'GET'}});
    const r = await fetch(url, {mode:'cors'});
    const j = await r.json();
    log({status:r.status,json:j});
    $('msg').textContent = JSON.stringify(j,null,2);
  }catch(e){
    log({error:e.name,message:e.message});
    alert('Fetch error: ' + e.message);
  }
};

$('raw').onclick = ()=>{
  const {email,password} = getCreds();
  const a = agent();
  const mailbox = $('mailbox').value.trim() || 'INBOX';
  const uid = Number($('rawUid').value);
  if (!email || !password || !uid) { alert('Need login + UID'); return; }
  const url = new URL(a + '/api/imap/get-raw');
  url.searchParams.set('email', email);
  url.searchParams.set('password', password);
  url.searchParams.set('mailbox', mailbox);
  url.searchParams.set('uid', uid);
  // navigate to download .eml
  location.href = url.toString();
};
</script>
