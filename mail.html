<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mail</title>
<style>
  :root { color-scheme: light dark; }
  *{box-sizing:border-box;}
  html,body{height:100%;}
  body{
    margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    display:grid;grid-template-rows:48px 1fr;min-height:100dvh;
  }
  .topbar{
    display:flex;align-items:center;gap:8px;
    border-bottom:1px solid rgba(0,0,0,.15);
    padding:0 8px;
  }
  .topbar h1{margin:0;font-size:15px;}
  .btn{
    border:1px solid rgba(0,0,0,.25);
    background:transparent;
    padding:6px 10px;cursor:pointer;
    transition:background-color .1s ease,transform .1s ease;
  }
  .btn:hover{background:rgba(0,0,0,.08);}
  .btn:active{transform:scale(.97);background:rgba(0,0,0,.15);}
  .wrap{display:grid;grid-template-columns:280px 1fr; min-height:0;}
  .sidebar{border-right:1px solid rgba(0,0,0,.15);display:grid;grid-template-rows:auto 1fr; min-height:0;}
  .folders{display:flex;gap:6px;padding:6px;border-bottom:1px solid rgba(0,0,0,.12);}
  .list{overflow:auto;min-height:0;}
  .row{padding:8px 10px;border-bottom:1px solid rgba(0,0,0,.1);cursor:pointer;}
  .row:hover{background:rgba(0,0,0,.05);}
  .viewer,.compose{padding:10px;overflow:auto;min-height:0;}
  .compose input,.compose textarea{
    width:100%;border:1px solid rgba(0,0,0,.25);padding:8px 10px;margin-bottom:8px; font-family:inherit; font-size:1rem;
  }
  .compose textarea{min-height:200px; resize:vertical;}
  .hidden{display:none;}
  .status{font-size:12px;opacity:.8;padding:8px;}
  .headerline{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
  .spacer{flex:1;}
</style>
</head>
<body>
<div class="topbar">
  <h1 id="brand">Mail</h1>
  <div class="spacer"></div>
  <button id="composeBtn" class="btn">Compose</button>
  <button id="refreshBtn" class="btn">Refresh</button>
  <button id="logoutBtn" class="btn">Logout</button>
</div>

<div class="wrap">
  <aside class="sidebar">
    <div class="folders">
      <button class="btn" data-folder="inbox">Inbox</button>
      <button class="btn" data-folder="sent">Sent</button>
      <button class="btn" data-folder="trash">Trash</button>
    </div>
    <div class="list" id="list"></div>
  </aside>

  <section class="viewer" id="viewer">
    <div id="viewerEmpty" class="status">Select a message.</div>
    <div id="viewerCard" class="hidden">
      <div class="headerline">
        <div id="vSubject" style="font-weight:600;"></div>
        <div class="spacer"></div>
        <div id="vDate" class="status" style="padding:0;"></div>
      </div>
      <div id="vFrom" class="status" style="padding:0;"></div>
      <pre id="vBody" style="white-space:pre-wrap;"></pre>
      <button id="replyBtn" class="btn">Reply</button>
    </div>
  </section>

  <section class="compose hidden" id="composeView">
    <button id="backBtn" class="btn">← Back</button><br>
    <input id="cTo" type="email" placeholder="To">
    <input id="cSubject" placeholder="Subject">
    <textarea id="cBody" placeholder="Message"></textarea>
    <button id="sendBtn" class="btn">Send</button>
    <div id="composeStatus" class="status"></div>
  </section>
</div>

<script type="module">
const BACKEND="https://emailserverbackend-production.up.railway.app"; // change if needed
const el = (id) => document.getElementById(id);

const list=el("list"), vCard=el("viewerCard"), vEmpty=el("viewerEmpty"),
      vSubject=el("vSubject"), vFrom=el("vFrom"), vDate=el("vDate"), vBody=el("vBody"),
      composeView=el("composeView");

async function api(path,opt={}) {
  const r=await fetch(BACKEND+path,{credentials:"include",...opt});
  if(r.status===401){ location.href="index.html"; return Promise.reject(new Error("unauthorized")); }
  if(!r.ok) throw new Error("API "+r.status);
  return r.json();
}

async function bootstrap() {
  try {
    const me = await api("/api/me");
    el("brand").textContent = me?.email ? `Mail — ${me.email}` : "Mail";
  } catch { /* redirected if 401 */ }
  loadList("inbox");
}

async function loadList(folder="inbox"){
  list.innerHTML="<div class='status'>Loading…</div>";
  try {
    const d=await api(`/api/mail/messages?folder=${encodeURIComponent(folder)}&page=1`);
    list.innerHTML="";
    if (!d.items || !d.items.length) {
      list.innerHTML = "<div class='status'>No messages.</div>";
      vCard.classList.add("hidden"); vEmpty.classList.remove("hidden");
      return;
    }
    for(const m of d.items){
      const row=document.createElement("div");
      row.className="row";
      row.textContent=`${m.from} — ${m.subject || "(no subject)"}`;
      row.onclick=()=>openMsg(m.id);
      list.appendChild(row);
    }
  } catch(e){
    list.innerHTML = `<div class='status'>Failed to load: ${e.message||e}</div>`;
  }
}

async function openMsg(id){
  try{
    const m=await api("/api/mail/messages/"+encodeURIComponent(id));
    vSubject.textContent=m.subject||"(no subject)";
    vFrom.textContent=m.from||"";
    vDate.textContent=m.date? new Date(m.date).toLocaleString(): "";
    vBody.textContent=m.body||"";
    vEmpty.classList.add("hidden");
    vCard.classList.remove("hidden");
  }catch(e){
    vEmpty.textContent = "Failed to open message.";
    vCard.classList.add("hidden"); vEmpty.classList.remove("hidden");
  }
}

el("composeBtn").onclick=()=>{ composeView.classList.remove("hidden"); el("viewer").classList.add("hidden"); };
el("backBtn").onclick=()=>{ composeView.classList.add("hidden"); el("viewer").classList.remove("hidden"); };

el("sendBtn").onclick=async()=>{
  const to=el("cTo").value.trim(), subject=el("cSubject").value, body=el("cBody").value;
  if(!to){ el("composeStatus").textContent="Enter a recipient."; return; }
  el("composeStatus").textContent="Sending…";
  try{
    const r=await api("/api/mail/send",{
      method:"POST",
      headers:{"content-type":"application/json"},
      body:JSON.stringify({to,subject,body})
    });
    if(r.ok){ el("composeStatus").textContent="Sent."; }
    else { el("composeStatus").textContent="Send failed."; }
  }catch(e){
    el("composeStatus").textContent="Send failed.";
  }
};

el("logoutBtn").onclick=async()=>{ try{ await api("/api/auth/logout",{method:"POST"}); }catch{} location.href="index.html"; };
el("refreshBtn").onclick=()=>loadList();

document.querySelectorAll('.folders .btn').forEach(b=>{
  b.addEventListener('click', ()=> loadList(b.dataset.folder || 'inbox'));
});

bootstrap();
</script>
</body>
</html>
